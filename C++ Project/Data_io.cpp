#include "login_system.h"
#include <fstream>

const string DATA_FILE = "users.dat";
const string BACKUP_FILE = "users.bak";

void backupData()
{
	ifstream src(DATA_FILE, ios::binary);
	ofstream dst(BACKUP_FILE, ios::binary);
    dst << src.rdbuf();
}

vector<User> loadUsers()
{
	vector<User> users;
	ifstream fin(DATA_FILE, ios::binary);
	if (!fin) return users;
	int n;
	fin >> n;
	users.resize(n);
	for (auto& u : users)
	{
		int m;
		fin >> u.username >> u.passwordHash >> u.fullName
			>> u.isAdmin >> u.isAutoGenerated
			>> u.wallet.id >> u.wallet.balance;
		fin >> m;
		u.wallet.history.resize(m);
		for (auto& tx : u.wallet.history)
			fin >> tx.fromWallet >> tx.toWallet >> tx.amount >> tx.timestamp;
	}
	return users;
}

void saveUsers(const vector<User>& users)
{
	ofstream fout(DATA_FILE, ios::binary);
	fout << users.size() << "\n";
	for (const auto& u : users)
	{
		fout << u.username << " "
			<< u.passwordHash << " "
			<< u.fullName << " "
			<< u.isAdmin << " "
			<< u.isAutoGenerated << " "
			<< u.wallet.id << " "
			<< u.wallet.balance << " ";
		fout << u.wallet.history.size() << "\n";
		for (const auto& tx : u.wallet.history)
			fout << tx.fromWallet << " "
			<< tx.toWallet << " "
			<< tx.amount << " "
			<< tx.timestamp << "\n";
	}
}