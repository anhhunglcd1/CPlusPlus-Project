#include "login_system.h"
#include <fstream>
#include <iostream>
using namespace std;

const string DATA_FILE = "users.dat";
const string BACKUP_FILE = "users.bak";

void backupData() {
    ifstream src(DATA_FILE);
    ofstream dst(BACKUP_FILE);
    if (src && dst) dst << src.rdbuf();
}

vector<User> loadUsers() {
    vector<User> users;
    ifstream fin(DATA_FILE);
    if (!fin) return users;

    size_t n; fin >> n;
    users.reserve(n);
    for (size_t i = 0; i < n; ++i) {
        User u;
        size_t m;
        fin >> u.username
            >> u.passwordHash
            >> u.fullName
            >> u.isAdmin
            >> u.isAutoGenerated
            >> u.wallet.id
            >> u.wallet.balance
            >> u.otp
            >> u.pendingFullName
            >> u.pendingPasswordHash;
        // Xử lý nếu data cũ ghi "0" thay vì empty
        if (u.otp == "0") u.otp.clear();
        if (u.pendingFullName == "0") u.pendingFullName.clear();
        if (u.pendingPasswordHash == "0") u.pendingPasswordHash.clear();

        fin >> m;
        u.wallet.history.reserve(m);
        for (size_t j = 0; j < m; ++j) {
            Transaction tx;
            fin >> tx.fromWallet >> tx.toWallet >> tx.amount >> tx.timestamp;
            u.wallet.history.push_back(tx);
        }
        users.push_back(move(u));
    }
    return users;
}

void saveUsers(const vector<User>& users) {
    ofstream fout(DATA_FILE);
    fout << users.size() << '\n';
    for (auto& u : users) {
        fout << u.username << " "
            << u.passwordHash << " "
            << u.fullName << " "
            << u.isAdmin << " "
            << u.isAutoGenerated << " "
            << u.wallet.id << " "
            << u.wallet.balance << " "
            << (u.otp.empty() ? "0" : u.otp) << " "
            << (u.pendingFullName.empty() ? "0" : u.pendingFullName) << " "
            << (u.pendingPasswordHash.empty() ? "0" : u.pendingPasswordHash) << "\n";
        fout << u.wallet.history.size() << '\n';
        for (auto& tx : u.wallet.history)
            fout << tx.fromWallet << ' ' << tx.toWallet << ' ' << tx.amount << ' ' << tx.timestamp << '\n';
    }
}

void initPendingChangeFile() {
    ofstream fout("pending_change.txt", ios::app);
    fout.close();
}
