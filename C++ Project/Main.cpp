#include "login_system.h"
#include <iostream>
#include <iomanip>
#include <limits>
using namespace std;

int main() {
    initPendingChangeFile();
    srand((unsigned)time(nullptr));
    backupData();
    auto users = loadUsers();
    if (!findUser(users, "admin")) {
        User a;
        a.username = "admin";
        a.passwordHash = hashPassword("admin");
        a.fullName = "Administrator";
        a.isAdmin = true;
        a.isAutoGenerated = false;
        a.wallet.id = string("WAL") + to_string(time(nullptr));
        a.wallet.balance = -1;
        a.otp = "";
        a.pendingFullName = "";
        a.pendingPasswordHash = "";
        users.push_back(a);
        saveUsers(users);
        cout << "Default admin created: admin / admin\n";
    }
    while (true) {
        clearScreen();
        cout << "=============================================\n";
        cout << "          ACCOUNT MANAGEMENT SYSTEM       \n";
        cout << "=============================================\n\n";
        cout << left
            << setw(1) << "1." << setw(17) << "Register"
            << setw(1) << "2." << setw(17) << "Login"
            << setw(1) << "0." << "Exit" << '\n';
        cout << "---------------------------------------------\n";
        cout << "Choice: ";
        int cmd; cin >> cmd; cin.ignore(numeric_limits<streamsize>::max(), '\n');
        switch (cmd) {
        case 1: registerUser(users); break;
        case 2: {
            User* u = login(users);
            if (u) {
                if (u->isAdmin) adminMenu(u, users);
                else userMenu(u, users);
            }
            break;
        }
        case 0: cout << "Goodbye.\n"; return 0;
        default: cout << "Invalid choice.\n";
        }
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        cout << "\nPress Enter to return to main menu...";
        cin.get();
    }
    return 0;
}
