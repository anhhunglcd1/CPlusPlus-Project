#include "login_system.h"
#include <iostream>
#include <limits>    // Dùng numeric_limits để xử lý buffer input
using namespace std;

int main() {
    // ===== Bước khởi tạo hệ thống =====
    backupData();                // Sao lưu dữ liệu cũ
    auto users = loadUsers();    // Tải danh sách user từ file

    // --- Đảm bảo tồn tại tài khoản admin mặc định ---
    if (!findUser(users, "admin")) {
        User a;
        a.username = "admin";
        a.passwordHash = hashPassword("admin");
        a.fullName = "Administrator";
        a.isAdmin = true;
        a.isAutoGenerated = false;
        a.wallet.id = string("WAL") + to_string(time(nullptr));
        a.wallet.balance = -1;    // -1 biểu thị không giới hạn
        users.push_back(a);
        saveUsers(users);
        cout << "Default admin created: admin / admin\n";
    }
    // --- Kết thúc khởi tạo admin ---

    // ===== Vòng lặp menu chính =====
    while (true) {
        clearScreen();
        cout << "=== SYSTEM MENU ===\n"
            << "1. Register    2. Login    0. Exit\n"
            << "Choice: ";
        int cmd;
        cin >> cmd;
        // Xóa newline sau khi đọc cmd
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        switch (cmd) {
        case 1:
            // Đăng ký user mới (mặc định non-admin)
            registerUser(users);
            break;
        case 2: {
            // Đăng nhập, nếu thành công, chuyển đến menu tương ứng
            User* u = login(users);
            if (u) {
                if (u->isAdmin)
                    adminMenu(u, users);  // Menu cho Admin
                else
                    userMenu(u, users);   // Menu cho User thường
            }
            break;
        }
        case 0:
            // Thoát chương trình
            cout << "Goodbye.\n";
            return 0;
        default:
            cout << "Invalid choice.\n";
        }

        // Tạm dừng để người dùng đọc thông báo
        cout << "\nPress Enter to return to main menu...";
        cin.get();
    }
    return 0;
}
